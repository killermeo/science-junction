<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚öóÔ∏è Science Junction</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
    min-height: 100vh;
    color: white;
  }

  /* ===== SCREENS ===== */
  .screen { display: none; padding: 20px; min-height: 100vh; }
  .screen.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }

  /* ===== LOGIN SCREEN ===== */
  .logo-area { text-align: center; margin-bottom: 30px; }
  .logo-area h1 { font-size: 2.5em; font-weight: 800; background: linear-gradient(90deg, #f7971e, #ffd200); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .logo-area p { color: #aaa; margin-top: 5px; font-size: 0.95em; }

  .login-card {
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 20px;
    padding: 35px;
    width: 100%;
    max-width: 420px;
  }

  .tab-btns { display: flex; margin-bottom: 25px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 5px; }
  .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #aaa; border-radius: 8px; cursor: pointer; font-size: 0.95em; transition: all 0.3s; }
  .tab-btn.active { background: linear-gradient(135deg, #f7971e, #ffd200); color: #000; font-weight: 700; }

  .input-group { margin-bottom: 15px; }
  .input-group label { display: block; margin-bottom: 6px; color: #ccc; font-size: 0.9em; }
  .input-group input, .input-group select {
    width: 100%; padding: 12px 15px; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1); color: white; font-size: 1em;
    outline: none; transition: border 0.3s;
  }
  .input-group input:focus, .input-group select:focus { border-color: #ffd200; }
  .input-group select option { background: #302b63; color: white; }

  .btn-primary {
    width: 100%; padding: 14px; border: none; border-radius: 10px;
    background: linear-gradient(135deg, #f7971e, #ffd200);
    color: #000; font-size: 1.1em; font-weight: 700; cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    margin-top: 10px;
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(247,151,30,0.4); }
  .btn-primary:active { transform: translateY(0); }

  /* ===== EXAM SELECTION ===== */
  .page-title { font-size: 1.6em; font-weight: 700; margin-bottom: 5px; text-align: center; }
  .page-sub { color: #aaa; text-align: center; margin-bottom: 25px; font-size: 0.9em; }

  .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 500px; }
  .grid-3 { grid-template-columns: repeat(3, 1fr); }

  .card {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 15px; padding: 20px 15px;
    text-align: center; cursor: pointer;
    transition: all 0.3s;
  }
  .card:hover { background: rgba(247,151,30,0.2); border-color: #ffd200; transform: translateY(-3px); }
  .card .icon { font-size: 2em; margin-bottom: 8px; }
  .card .label { font-size: 0.9em; font-weight: 600; }
  .card .sub { font-size: 0.75em; color: #aaa; margin-top: 3px; }

  /* ===== TEST SCREEN ===== */
  .test-header {
    width: 100%; max-width: 650px;
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; background: rgba(255,255,255,0.08);
    border-radius: 12px; padding: 12px 18px;
  }
  .test-header .q-count { font-size: 0.9em; color: #aaa; }
  .test-header .q-count span { color: white; font-weight: 700; }

  .timer {
    background: linear-gradient(135deg, #f7971e, #ffd200);
    color: #000; padding: 6px 16px; border-radius: 20px;
    font-weight: 800; font-size: 1.1em;
  }
  .timer.warning { background: linear-gradient(135deg, #ff416c, #ff4b2b); color: white; animation: pulse 1s infinite; }

  @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }

  .question-card {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 20px; padding: 25px;
    width: 100%; max-width: 650px;
  }

  .q-number { color: #ffd200; font-size: 0.85em; margin-bottom: 10px; font-weight: 600; }
  .q-text { font-size: 1.05em; line-height: 1.6; margin-bottom: 20px; }

  .options { display: flex; flex-direction: column; gap: 10px; }
  .option {
    padding: 13px 18px; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.05);
    cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; gap: 12px;
  }
  .option:hover:not(.disabled) { border-color: #ffd200; background: rgba(255,210,0,0.1); }
  .option .opt-label {
    width: 28px; height: 28px; border-radius: 50%;
    background: rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.85em; font-weight: 700; flex-shrink: 0;
  }
  .option.correct { border-color: #00c853; background: rgba(0,200,83,0.15); }
  .option.correct .opt-label { background: #00c853; }
  .option.wrong { border-color: #ff1744; background: rgba(255,23,68,0.15); }
  .option.wrong .opt-label { background: #ff1744; }
  .option.disabled { cursor: not-allowed; }

  .explanation {
    margin-top: 15px; padding: 12px 15px;
    background: rgba(0,200,83,0.1); border-left: 3px solid #00c853;
    border-radius: 8px; font-size: 0.9em; color: #ccc; display: none;
  }

  .nav-btns { display: flex; gap: 12px; margin-top: 20px; width: 100%; max-width: 650px; }
  .btn-secondary {
    flex: 1; padding: 12px; border-radius: 10px;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    color: white; font-size: 1em; cursor: pointer; transition: all 0.2s;
  }
  .btn-secondary:hover { background: rgba(255,255,255,0.2); }

  /* ===== RESULT SCREEN ===== */
  .result-card {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 20px; padding: 35px;
    width: 100%; max-width: 450px; text-align: center;
  }

  .score-circle {
    width: 140px; height: 140px; border-radius: 50%;
    background: conic-gradient(#ffd200 var(--pct), rgba(255,255,255,0.1) 0);
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 20px; position: relative;
  }
  .score-circle::before {
    content: ''; position: absolute;
    width: 110px; height: 110px; border-radius: 50%;
    background: #1a1a2e;
  }
  .score-inner { position: relative; z-index: 1; }
  .score-pct { font-size: 2em; font-weight: 800; color: #ffd200; }
  .score-label { font-size: 0.75em; color: #aaa; }

  .result-stats { display: flex; justify-content: space-around; margin: 20px 0; }
  .stat { text-align: center; }
  .stat .val { font-size: 1.5em; font-weight: 700; }
  .stat .key { font-size: 0.8em; color: #aaa; margin-top: 2px; }
  .correct-val { color: #00c853; }
  .wrong-val { color: #ff1744; }
  .skip-val { color: #ffd200; }

  /* ===== LEADERBOARD ===== */
  .lb-item {
    display: flex; align-items: center; gap: 12px;
    background: rgba(255,255,255,0.06);
    border-radius: 10px; padding: 12px 15px; margin-bottom: 8px;
    width: 100%; max-width: 500px;
  }
  .lb-rank { font-size: 1.2em; width: 30px; text-align: center; }
  .lb-name { flex: 1; font-weight: 600; }
  .lb-score { color: #ffd200; font-weight: 700; }

  /* ===== LOADING ===== */
  .loading {
    display: flex; flex-direction: column; align-items: center; gap: 15px;
  }
  .spinner {
    width: 50px; height: 50px; border-radius: 50%;
    border: 4px solid rgba(255,255,255,0.1);
    border-top-color: #ffd200;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== TEACHER SCREEN ===== */
  .table-wrap { width: 100%; max-width: 700px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  th { background: rgba(247,151,30,0.3); padding: 10px; text-align: left; font-size: 0.85em; }
  td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 0.85em; }
  tr:hover td { background: rgba(255,255,255,0.04); }

  .back-btn {
    position: fixed; top: 15px; left: 15px;
    background: rgba(255,255,255,0.1); border: none;
    color: white; padding: 8px 15px; border-radius: 20px;
    cursor: pointer; font-size: 0.9em; transition: all 0.2s;
    backdrop-filter: blur(10px);
  }
  .back-btn:hover { background: rgba(255,255,255,0.2); }

  .badge {
    display: inline-block; padding: 3px 10px; border-radius: 20px;
    font-size: 0.75em; font-weight: 700;
    background: rgba(0,200,83,0.2); color: #00c853;
  }

  /* ===== PROGRESS BAR ===== */
  .progress-bar-wrap { width: 100%; max-width: 650px; margin-bottom: 15px; }
  .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, #f7971e, #ffd200); transition: width 0.3s; }

  .msg { color: #ff6b6b; font-size: 0.85em; margin-top: 8px; text-align: center; }
</style>
</head>
<body>

<!-- ===================== LOGIN SCREEN ===================== -->
<div id="screen-login" class="screen active">
  <div class="logo-area">
    <h1>‚öóÔ∏è Science Junction</h1>
    <p>AI-Powered Exam Preparation Platform</p>
  </div>

  <div class="login-card">
    <div class="tab-btns">
      <button class="tab-btn active" onclick="switchTab('student')">üéì Student</button>
      <button class="tab-btn" onclick="switchTab('teacher')">üë®‚Äçüè´ Teacher</button>
    </div>

    <!-- Student Login -->
    <div id="student-form">
      <div class="input-group">
        <label>‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
        <input type="text" id="student-name" placeholder="‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç...">
      </div>
      <div class="input-group">
        <label>Exam ‡§ö‡•Å‡§®‡•á‡§Ç</label>
        <select id="student-exam">
          <option value="">-- Exam ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
          <option value="JEE">üî¨ JEE (Engineering)</option>
          <option value="NEET">üß¨ NEET (Medical)</option>
          <option value="NDA">‚öîÔ∏è NDA (Defence)</option>
          <option value="CLAT">‚öñÔ∏è CLAT (Law)</option>
          <option value="Class 9">üìö Class 9</option>
          <option value="Class 10">üìö Class 10</option>
          <option value="Class 11">üìö Class 11</option>
          <option value="Class 12">üìö Class 12</option>
        </select>
      </div>
      <p id="login-msg" class="msg"></p>
      <button class="btn-primary" onclick="studentLogin()">‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç ‚Üí</button>
    </div>

    <!-- Teacher Login -->
    <div id="teacher-form" style="display:none">
      <div class="input-group">
        <label>Teacher Password</label>
        <input type="password" id="teacher-pass" placeholder="Password ‡§°‡§æ‡§≤‡•á‡§Ç...">
      </div>
      <p id="teacher-msg" class="msg"></p>
      <button class="btn-primary" onclick="teacherLogin()">Login ‡§ï‡§∞‡•á‡§Ç ‚Üí</button>
    </div>
  </div>
</div>

<!-- ===================== SUBJECT SELECTION ===================== -->
<div id="screen-subject" class="screen">
  <button class="back-btn" onclick="goTo('screen-login')">‚Üê ‡§µ‡§æ‡§™‡§∏</button>
  <p class="page-sub" id="welcome-msg" style="font-size:1.1em; margin-bottom:5px;"></p>
  <h2 class="page-title">Subject ‡§ö‡•Å‡§®‡•á‡§Ç</h2>
  <p class="page-sub">‡§ï‡•å‡§® ‡§∏‡§æ subject ‡§™‡§¢‡§º‡§®‡§æ ‡§π‡•à?</p>

  <div class="grid" id="subject-grid">
    <!-- dynamically filled -->
  </div>
</div>

<!-- ===================== TEST TYPE SELECTION ===================== -->
<div id="screen-testtype" class="screen">
  <button class="back-btn" onclick="goTo('screen-subject')">‚Üê ‡§µ‡§æ‡§™‡§∏</button>
  <h2 class="page-title">Test Type ‡§ö‡•Å‡§®‡•á‡§Ç</h2>
  <p class="page-sub" id="selected-subject-label"></p>

  <div class="grid">
    <div class="card" onclick="startTest('chapter')">
      <div class="icon">üìñ</div>
      <div class="label">Chapter Test</div>
      <div class="sub">10 Questions</div>
    </div>
    <div class="card" onclick="startTest('mock')">
      <div class="icon">üèÜ</div>
      <div class="label">Full Mock Test</div>
      <div class="sub">30 Questions</div>
    </div>
  </div>
</div>

<!-- ===================== LOADING SCREEN ===================== -->
<div id="screen-loading" class="screen">
  <div class="loading">
    <div class="spinner"></div>
    <h3>AI Questions ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</h3>
    <p style="color:#aaa; font-size:0.9em;">Groq AI ‡§∏‡•á questions generate ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç</p>
  </div>
</div>

<!-- ===================== TEST SCREEN ===================== -->
<div id="screen-test" class="screen" style="justify-content:flex-start; padding-top:70px;">
  <button class="back-btn" onclick="confirmExit()">‚úï Exit</button>

  <div class="progress-bar-wrap">
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
  </div>

  <div class="test-header">
    <div class="q-count">Question <span id="q-current">1</span> / <span id="q-total">10</span></div>
    <div class="timer" id="timer">30:00</div>
  </div>

  <div class="question-card">
    <div class="q-number" id="q-num-label">Q1.</div>
    <div class="q-text" id="q-text">Loading...</div>
    <div class="options" id="options-container"></div>
    <div class="explanation" id="explanation"></div>
  </div>

  <div class="nav-btns">
    <button class="btn-secondary" onclick="prevQuestion()">‚Üê ‡§™‡§ø‡§õ‡§≤‡§æ</button>
    <button class="btn-primary" id="next-btn" onclick="nextQuestion()" style="flex:2;">‡§Ö‡§ó‡§≤‡§æ ‚Üí</button>
  </div>
</div>

<!-- ===================== RESULT SCREEN ===================== -->
<div id="screen-result" class="screen">
  <div class="result-card">
    <h2 style="margin-bottom:20px;">üéØ Result</h2>

    <div class="score-circle" id="score-circle">
      <div class="score-inner">
        <div class="score-pct" id="result-pct">0%</div>
        <div class="score-label">Score</div>
      </div>
    </div>

    <div class="result-stats">
      <div class="stat"><div class="val correct-val" id="r-correct">0</div><div class="key">‚úÖ Correct</div></div>
      <div class="stat"><div class="val wrong-val" id="r-wrong">0</div><div class="key">‚ùå Wrong</div></div>
      <div class="stat"><div class="val skip-val" id="r-skip">0</div><div class="key">‚è≠Ô∏è Skip</div></div>
    </div>

    <p id="result-msg" style="color:#aaa; margin: 10px 0 20px; font-size:0.9em;"></p>

    <div style="display:flex; gap:10px;">
      <button class="btn-secondary" onclick="goTo('screen-subject')">üîÑ ‡§´‡§ø‡§∞ ‡§∏‡•á</button>
      <button class="btn-primary" onclick="goTo('screen-leaderboard')">üèÜ Leaderboard</button>
    </div>
  </div>
</div>

<!-- ===================== LEADERBOARD ===================== -->
<div id="screen-leaderboard" class="screen" style="justify-content:flex-start; padding-top:70px;">
  <button class="back-btn" onclick="goTo('screen-subject')">‚Üê ‡§µ‡§æ‡§™‡§∏</button>
  <h2 class="page-title" style="margin-bottom:5px;">üèÜ Leaderboard</h2>
  <p class="page-sub">Top Performers</p>
  <div id="lb-container" style="width:100%;">
    <div class="loading"><div class="spinner"></div></div>
  </div>
</div>

<!-- ===================== TEACHER SCREEN ===================== -->
<div id="screen-teacher" class="screen" style="justify-content:flex-start; padding-top:70px;">
  <button class="back-btn" onclick="goTo('screen-login')">‚Üê Logout</button>
  <h2 class="page-title" style="margin-bottom:5px;">üë®‚Äçüè´ Teacher Dashboard</h2>
  <p class="page-sub">‡§∏‡§≠‡•Ä Students ‡§ï‡•á Results</p>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>‡§®‡§æ‡§Æ</th>
          <th>Exam</th>
          <th>Subject</th>
          <th>Score</th>
          <th>%</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="teacher-table"></tbody>
    </table>
  </div>
</div>

<script>
// =====================================================
// CONFIGURATION
// =====================================================
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwRtvck-c-9ZKPo4VynOdCX5gVW4wa745d0_Tix23cJhn5n-RM9SAIWl9dBA1DLz-MMgA/exec";
const TEACHER_PASSWORD = "science123";

// =====================================================
// SUBJECTS BY EXAM
// =====================================================
const SUBJECTS = {
  "JEE": [
    { icon: "‚öõÔ∏è", label: "Physics", sub: "Mechanics, Waves, Optics" },
    { icon: "üß™", label: "Chemistry", sub: "Organic, Inorganic, Physical" },
    { icon: "üî¢", label: "Mathematics", sub: "Calculus, Algebra, Geometry" }
  ],
  "NEET": [
    { icon: "‚öõÔ∏è", label: "Physics", sub: "Mechanics, Thermodynamics" },
    { icon: "üß™", label: "Chemistry", sub: "Organic & Inorganic" },
    { icon: "üåø", label: "Botany", sub: "Plant Biology" },
    { icon: "ü¶†", label: "Zoology", sub: "Animal Biology" }
  ],
  "NDA": [
    { icon: "üî¢", label: "Mathematics", sub: "Algebra, Calculus" },
    { icon: "üåç", label: "General Studies", sub: "Science, History, GK" },
    { icon: "üìù", label: "English", sub: "Grammar, Comprehension" }
  ],
  "CLAT": [
    { icon: "‚öñÔ∏è", label: "Legal Reasoning", sub: "Law Basics" },
    { icon: "üìù", label: "English", sub: "Comprehension" },
    { icon: "üß†", label: "Logical Reasoning", sub: "Puzzles, Deduction" },
    { icon: "üî¢", label: "Quantitative", sub: "Maths Basics" }
  ],
  "Class 9": [
    { icon: "‚öõÔ∏è", label: "Science", sub: "Physics, Chemistry, Bio" },
    { icon: "üî¢", label: "Mathematics", sub: "Algebra, Geometry" },
    { icon: "üåç", label: "Social Science", sub: "History, Geography" }
  ],
  "Class 10": [
    { icon: "‚öõÔ∏è", label: "Science", sub: "Physics, Chemistry, Bio" },
    { icon: "üî¢", label: "Mathematics", sub: "Algebra, Trigonometry" },
    { icon: "üåç", label: "Social Science", sub: "History, Geography" }
  ],
  "Class 11": [
    { icon: "‚öõÔ∏è", label: "Physics", sub: "Mechanics, Thermodynamics" },
    { icon: "üß™", label: "Chemistry", sub: "Organic & Inorganic" },
    { icon: "üî¢", label: "Mathematics", sub: "Calculus, Algebra" }
  ],
  "Class 12": [
    { icon: "‚öõÔ∏è", label: "Physics", sub: "Electrostatics, Optics" },
    { icon: "üß™", label: "Chemistry", sub: "Electrochemistry, Polymers" },
    { icon: "üî¢", label: "Mathematics", sub: "Integration, Vectors" }
  ]
};

// =====================================================
// STATE
// =====================================================
let state = {
  name: "", exam: "", subject: "", testType: "",
  questions: [], currentQ: 0, answers: [],
  timerInterval: null, timeLeft: 0
};

// =====================================================
// NAVIGATION
// =====================================================
function goTo(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

// =====================================================
// LOGIN
// =====================================================
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('student-form').style.display = tab === 'student' ? 'block' : 'none';
  document.getElementById('teacher-form').style.display = tab === 'teacher' ? 'block' : 'none';
}

function studentLogin() {
  const name = document.getElementById('student-name').value.trim();
  const exam = document.getElementById('student-exam').value;
  const msg = document.getElementById('login-msg');

  if (!name) { msg.textContent = "‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç"; return; }
  if (!exam) { msg.textContent = "‡§ï‡•É‡§™‡§Ø‡§æ Exam ‡§ö‡•Å‡§®‡•á‡§Ç"; return; }

  state.name = name;
  state.exam = exam;
  msg.textContent = "";

  document.getElementById('welcome-msg').textContent = "‡§®‡§Æ‡§∏‡•ç‡§§‡•á " + name + " üëã";
  loadSubjects(exam);
  goTo('screen-subject');
}

function teacherLogin() {
  const pass = document.getElementById('teacher-pass').value;
  if (pass === TEACHER_PASSWORD) {
    loadTeacherData();
    goTo('screen-teacher');
  } else {
    document.getElementById('teacher-msg').textContent = "‡§ó‡§≤‡§§ password!";
  }
}

// =====================================================
// SUBJECT SELECTION
// =====================================================
function loadSubjects(exam) {
  const subjects = SUBJECTS[exam] || [];
  const grid = document.getElementById('subject-grid');
  grid.innerHTML = '';
  subjects.forEach(s => {
    grid.innerHTML += `
      <div class="card" onclick="selectSubject('${s.label}')">
        <div class="icon">${s.icon}</div>
        <div class="label">${s.label}</div>
        <div class="sub">${s.sub}</div>
      </div>`;
  });
}

function selectSubject(subject) {
  state.subject = subject;
  document.getElementById('selected-subject-label').textContent = state.exam + " ‚Üí " + subject;
  goTo('screen-testtype');
}

// =====================================================
// START TEST
// =====================================================
function startTest(type) {
  state.testType = type;
  state.currentQ = 0;
  state.answers = [];
  const count = type === 'mock' ? 30 : 10;
  state.timeLeft = type === 'mock' ? 1800 : 600; // 30 min or 10 min

  goTo('screen-loading');

  const url = `${APPS_SCRIPT_URL}?action=getQuestions&subject=${encodeURIComponent(state.subject)}&exam=${encodeURIComponent(state.exam)}&count=${count}`;

  fetch(url)
    .then(r => r.json())
    .then(data => {
      if (data.success && data.questions && data.questions.length > 0) {
        state.questions = data.questions;
      } else {
        state.questions = getLocalBackup();
      }
      initTest();
    })
    .catch(() => {
      state.questions = getLocalBackup();
      initTest();
    });
}

function initTest() {
  document.getElementById('q-total').textContent = state.questions.length;
  state.answers = new Array(state.questions.length).fill(-1);
  showQuestion(0);
  startTimer();
  goTo('screen-test');
}

// =====================================================
// QUESTIONS
// =====================================================
function showQuestion(idx) {
  const q = state.questions[idx];
  if (!q) return;

  state.currentQ = idx;
  document.getElementById('q-current').textContent = idx + 1;
  document.getElementById('q-num-label').textContent = `Q${idx + 1}.`;
  document.getElementById('q-text').textContent = q.question;
  document.getElementById('explanation').style.display = 'none';
  document.getElementById('explanation').textContent = '';

  // Progress bar
  const pct = ((idx + 1) / state.questions.length) * 100;
  document.getElementById('progress-fill').style.width = pct + '%';

  // Options
  const container = document.getElementById('options-container');
  container.innerHTML = '';
  const labels = ['A', 'B', 'C', 'D'];
  const answered = state.answers[idx] !== -1;

  q.options.forEach((opt, i) => {
    const div = document.createElement('div');
    div.className = 'option' + (answered ? ' disabled' : '');

    if (answered) {
      if (i === q.correct) div.classList.add('correct');
      else if (i === state.answers[idx]) div.classList.add('wrong');
    }

    div.innerHTML = `<div class="opt-label">${labels[i]}</div><div>${opt}</div>`;
    if (!answered) div.onclick = () => selectAnswer(i);
    container.appendChild(div);
  });

  if (answered && q.explanation) {
    const exp = document.getElementById('explanation');
    exp.textContent = 'üí° ' + q.explanation;
    exp.style.display = 'block';
  }

  // Next/Submit button
  const nextBtn = document.getElementById('next-btn');
  nextBtn.textContent = idx === state.questions.length - 1 ? '‚úÖ Submit ‡§ï‡§∞‡•á‡§Ç' : '‡§Ö‡§ó‡§≤‡§æ ‚Üí';
}

function selectAnswer(optIdx) {
  state.answers[state.currentQ] = optIdx;
  showQuestion(state.currentQ);
}

function nextQuestion() {
  if (state.currentQ === state.questions.length - 1) {
    submitTest();
  } else {
    showQuestion(state.currentQ + 1);
  }
}

function prevQuestion() {
  if (state.currentQ > 0) showQuestion(state.currentQ - 1);
}

function confirmExit() {
  if (confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ test ‡§õ‡•ã‡§°‡§º‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) {
    clearInterval(state.timerInterval);
    goTo('screen-subject');
  }
}

// =====================================================
// TIMER
// =====================================================
function startTimer() {
  clearInterval(state.timerInterval);
  updateTimerDisplay();
  state.timerInterval = setInterval(() => {
    state.timeLeft--;
    updateTimerDisplay();
    if (state.timeLeft <= 0) {
      clearInterval(state.timerInterval);
      submitTest();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const m = Math.floor(state.timeLeft / 60);
  const s = state.timeLeft % 60;
  const el = document.getElementById('timer');
  el.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  el.className = 'timer' + (state.timeLeft < 60 ? ' warning' : '');
}

// =====================================================
// SUBMIT TEST
// =====================================================
function submitTest() {
  clearInterval(state.timerInterval);

  let correct = 0, wrong = 0, skip = 0;
  state.questions.forEach((q, i) => {
    if (state.answers[i] === -1) skip++;
    else if (state.answers[i] === q.correct) correct++;
    else wrong++;
  });

  const total = state.questions.length;
  const pct = Math.round((correct / total) * 100);

  // Show result
  document.getElementById('result-pct').textContent = pct + '%';
  document.getElementById('r-correct').textContent = correct;
  document.getElementById('r-wrong').textContent = wrong;
  document.getElementById('r-skip').textContent = skip;
  document.getElementById('score-circle').style.setProperty('--pct', pct + '%');

  const msgs = pct >= 80 ? "üéâ ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞! ‡§¨‡•á‡§π‡§§‡§∞‡•Ä‡§® performance!" :
               pct >= 60 ? "üëç ‡§Ö‡§ö‡•ç‡§õ‡§æ! ‡§•‡•ã‡§°‡§º‡•Ä ‡§î‡§∞ ‡§Æ‡•á‡§π‡§®‡§§ ‡§ï‡§∞‡•ã‡•§" :
               pct >= 40 ? "üìö ‡§î‡§∞ ‡§™‡§¢‡§º‡§æ‡§à ‡§ï‡§∞‡•ã, ‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§π‡•ã‡§ó‡§æ‡•§" : "üí™ ‡§π‡§æ‡§∞ ‡§Æ‡§§ ‡§Æ‡§æ‡§®‡•ã, ‡§´‡§ø‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•ã!";
  document.getElementById('result-msg').textContent = msgs;

  // Save to sheet
  const url = `${APPS_SCRIPT_URL}?action=saveResult&name=${encodeURIComponent(state.name)}&exam=${encodeURIComponent(state.exam)}&subject=${encodeURIComponent(state.subject)}&score=${correct}&total=${total}&percentage=${pct}%`;
  fetch(url).catch(() => {});

  goTo('screen-result');
}

// =====================================================
// LEADERBOARD
// =====================================================
document.getElementById('screen-leaderboard').addEventListener('click', function(e) {
  if (this.classList.contains('active') && !this._loaded) {
    this._loaded = true;
    loadLeaderboard();
  }
});

function loadLeaderboard() {
  const url = `${APPS_SCRIPT_URL}?action=getLeaderboard`;
  fetch(url)
    .then(r => r.json())
    .then(data => {
      const container = document.getElementById('lb-container');
      if (!data.data || data.data.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#aaa;">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à result ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>';
        return;
      }
      const medals = ['ü•á', 'ü•à', 'ü•â'];
      container.innerHTML = data.data.map((r, i) => `
        <div class="lb-item">
          <div class="lb-rank">${medals[i] || (i+1)}</div>
          <div>
            <div class="lb-name">${r.name}</div>
            <div style="font-size:0.8em;color:#aaa;">${r.exam} ‚Ä¢ ${r.subject}</div>
          </div>
          <div class="lb-score">${r.percentage}</div>
        </div>
      `).join('');
    })
    .catch(() => {
      document.getElementById('lb-container').innerHTML = '<p style="text-align:center;color:#aaa;">Data load ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§</p>';
    });
}

// =====================================================
// TEACHER DASHBOARD
// =====================================================
function loadTeacherData() {
  const url = `${APPS_SCRIPT_URL}?action=getLeaderboard`;
  fetch(url)
    .then(r => r.json())
    .then(data => {
      const tbody = document.getElementById('teacher-table');
      if (!data.data || data.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#aaa;">‡§ï‡•ã‡§à data ‡§®‡§π‡•Ä‡§Ç</td></tr>';
        return;
      }
      tbody.innerHTML = data.data.map((r, i) => `
        <tr>
          <td>${i+1}</td>
          <td>${r.name}</td>
          <td>${r.exam}</td>
          <td>${r.subject}</td>
          <td>${r.score}/${r.total}</td>
          <td><span class="badge">${r.percentage}</span></td>
          <td>${r.date}</td>
        </tr>
      `).join('');
    })
    .catch(() => {});
}

// =====================================================
// LOCAL BACKUP QUESTIONS
// =====================================================
function getLocalBackup() {
  return [
    { question: "‡§®‡•ç‡§Ø‡•Ç‡§ü‡§® ‡§ï‡§æ ‡§ó‡§§‡§ø ‡§ï‡§æ ‡§™‡§π‡§≤‡§æ ‡§®‡§ø‡§Ø‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§π‡§§‡§æ ‡§π‡•à?", options: ["‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•Ä ‡§∏‡§Æ‡§æ‡§® ‡§î‡§∞ ‡§µ‡§ø‡§™‡§∞‡•Ä‡§§ ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à", "‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å ‡§§‡§¨ ‡§§‡§ï ‡§Ö‡§™‡§®‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§∞‡§π‡§§‡•Ä ‡§π‡•à ‡§ú‡§¨ ‡§§‡§ï ‡§â‡§∏ ‡§™‡§∞ ‡§¨‡§≤ ‡§® ‡§≤‡§ó‡§æ‡§Ø‡§æ ‡§ú‡§æ‡§è", "‡§¨‡§≤ = ‡§¶‡•ç‡§∞‡§µ‡•ç‡§Ø‡§Æ‡§æ‡§® √ó ‡§§‡•ç‡§µ‡§∞‡§£", "‡§ä‡§∞‡•ç‡§ú‡§æ ‡§® ‡§§‡•ã ‡§¨‡§®‡§æ‡§à ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à ‡§® ‡§®‡§∑‡•ç‡§ü ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à"], correct: 1, explanation: "‡§®‡•ç‡§Ø‡•Ç‡§ü‡§® ‡§ï‡§æ ‡§™‡§π‡§≤‡§æ ‡§®‡§ø‡§Ø‡§Æ ‡§ú‡§°‡§º‡§§‡•ç‡§µ ‡§ï‡§æ ‡§®‡§ø‡§Ø‡§Æ ‡§π‡•à‡•§" },
    { question: "‡§™‡•ç‡§∞‡§ï‡§æ‡§∂ ‡§ï‡•Ä ‡§ó‡§§‡§ø ‡§®‡§ø‡§∞‡•ç‡§µ‡§æ‡§§ ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§§‡§®‡•Ä ‡§π‡•ã‡§§‡•Ä ‡§π‡•à?", options: ["3 √ó 10‚Å∂ m/s", "3 √ó 10‚Å∏ m/s", "3 √ó 10¬π‚Å∞ m/s", "3 √ó 10‚Å¥ m/s"], correct: 1, explanation: "‡§™‡•ç‡§∞‡§ï‡§æ‡§∂ ‡§ï‡•Ä ‡§ó‡§§‡§ø 3 √ó 10‚Å∏ m/s ‡§π‡•à‡•§" },
    { question: "‡§™‡§∞‡§Æ‡§æ‡§£‡•Å ‡§ï‡•á ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•ã‡§§‡§æ ‡§π‡•à?", options: ["‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡•â‡§®", "‡§®‡•ç‡§Ø‡•Ç‡§ü‡•ç‡§∞‡•â‡§®", "‡§®‡§æ‡§≠‡§ø‡§ï", "‡§™‡•ç‡§∞‡•ã‡§ü‡•â‡§®"], correct: 2, explanation: "‡§™‡§∞‡§Æ‡§æ‡§£‡•Å ‡§ï‡•á ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§®‡§æ‡§≠‡§ø‡§ï ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§" },
    { question: "‡§ì‡§Æ ‡§ï‡§æ ‡§®‡§ø‡§Ø‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?", options: ["V = IR", "P = IV", "F = ma", "E = mc¬≤"], correct: 0, explanation: "‡§ì‡§Æ ‡§ï‡•á ‡§®‡§ø‡§Ø‡§Æ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ V = IR‡•§" },
    { question: "DNA ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?", options: ["Deoxyribonucleic Acid", "Diribonucleic Acid", "Double Nuclear Acid", "Deoxyribose Acid"], correct: 0, explanation: "DNA = Deoxyribonucleic Acid‡•§" },
    { question: "‡§™‡§æ‡§®‡•Ä ‡§ï‡§æ ‡§∞‡§æ‡§∏‡§æ‡§Ø‡§®‡§ø‡§ï ‡§∏‡•Ç‡§§‡•ç‡§∞ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?", options: ["CO‚ÇÇ", "H‚ÇÇO", "NaCl", "O‚ÇÇ"], correct: 1, explanation: "‡§™‡§æ‡§®‡•Ä ‡§ï‡§æ ‡§∏‡•Ç‡§§‡•ç‡§∞ H‚ÇÇO ‡§π‡•à‡•§" },
    { question: "‡§™‡•É‡§•‡•ç‡§µ‡•Ä ‡§™‡§∞ ‡§ó‡•Å‡§∞‡•Å‡§§‡•ç‡§µ‡§æ‡§ï‡§∞‡•ç‡§∑‡§£ ‡§ï‡§æ ‡§Æ‡§æ‡§® ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?", options: ["9.8 m/s¬≤", "8.9 m/s¬≤", "10.8 m/s¬≤", "6.7 m/s¬≤"], correct: 0, explanation: "g = 9.8 m/s¬≤ (‡§≤‡§ó‡§≠‡§ó 10 m/s¬≤)‡•§" },
    { question: "‡§™‡•ç‡§∞‡§ï‡§æ‡§∂-‡§∏‡§Ç‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§Æ‡•á‡§Ç ‡§ï‡•å‡§® ‡§∏‡•Ä ‡§ó‡•à‡§∏ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§π‡•ã‡§§‡•Ä ‡§π‡•à?", options: ["CO‚ÇÇ", "N‚ÇÇ", "O‚ÇÇ", "H‚ÇÇ"], correct: 2, explanation: "‡§™‡•ç‡§∞‡§ï‡§æ‡§∂-‡§∏‡§Ç‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§Æ‡•á‡§Ç ‡§ë‡§ï‡•ç‡§∏‡•Ä‡§ú‡§® (O‚ÇÇ) ‡§¨‡§®‡§§‡•Ä ‡§π‡•à‡•§" },
    { question: "‡§Ü‡§µ‡§∞‡•ç‡§§ ‡§∏‡§æ‡§∞‡§£‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡§¨‡§∏‡•á ‡§π‡§≤‡•ç‡§ï‡§æ ‡§§‡§§‡•ç‡§µ ‡§ï‡•å‡§® ‡§∏‡§æ ‡§π‡•à?", options: ["‡§π‡•Ä‡§≤‡§ø‡§Ø‡§Æ", "‡§π‡§æ‡§á‡§°‡•ç‡§∞‡•ã‡§ú‡§®", "‡§≤‡§ø‡§•‡§ø‡§Ø‡§Æ", "‡§ï‡§æ‡§∞‡•ç‡§¨‡§®"], correct: 1, explanation: "‡§π‡§æ‡§á‡§°‡•ç‡§∞‡•ã‡§ú‡§® ‡§∏‡§¨‡§∏‡•á ‡§π‡§≤‡•ç‡§ï‡§æ ‡§§‡§§‡•ç‡§µ ‡§π‡•à‡•§" },
    { question: "‡§¨‡§ø‡§ú‡§≤‡•Ä ‡§ï‡§æ SI ‡§Æ‡§æ‡§§‡•ç‡§∞‡§ï ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?", options: ["‡§µ‡•ã‡§≤‡•ç‡§ü", "‡§è‡§Æ‡•ç‡§™‡•Ä‡§Ø‡§∞", "‡§ì‡§Æ", "‡§µ‡§æ‡§ü"], correct: 1, explanation: "‡§µ‡§ø‡§¶‡•ç‡§Ø‡•Å‡§§ ‡§ß‡§æ‡§∞‡§æ ‡§ï‡§æ SI ‡§Æ‡§æ‡§§‡•ç‡§∞‡§ï ‡§è‡§Æ‡•ç‡§™‡•Ä‡§Ø‡§∞ ‡§π‡•à‡•§" }
  ];
}
</script>
</body>
</html>
